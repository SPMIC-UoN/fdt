<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><meta http-equiv="Content-Type"
content="text/html;charset=utf-8">
<link REL="stylesheet" TYPE="text/css"
href="../fsl.css"><TITLE>FSL</TITLE></HEAD>
<BODY><IFRAME width="100%" scrolling="no" frameborder="0" src="fdt_top.html">Broken</IFRAME>



<h3>Using surfaces in probtrackx</h3>

<p>In probtrackx, it is possible to use surfaces as ROIs. These can be <b>seed masks</b> or any type of <b>optional targets</b>.
It is also possible to combine volume files with surface files into the <i>same</i> "ROI".

<p>Probtrackx can read surfaces written using the following softwares: 
<a href="http://surfer.nmr.mgh.harvard.edu">FreeSurfer</a>,
<a href="http://brainvis.wustl.edu/wiki/index.php/Caret:About">Caret</a>,and 
<a href="http://www.fmrib.ox.ac.uk/fsl/first">FIRST</a>.

<p>For more details on these surface formats, follow this <a href="fdt_probtrackx_surface_formats.html">link</a>.


<h4>Why use surfaces for tractography?</h4>

<p>There are many reasons why it is a good idea to use surfaces instead of voxels within a tractography experiment. For example, it allows you to:
<p>
<ul>
<li> Use an accurate model for grey/white matter interface (based on a higher resolution T1-weighted image)  as a seed
<li> Get sub-voxel accuracy in seeding and/or detecting collision with an ROI
<li> Avoid crossing cortical sulci by setting a surface-type stopping mask
<li> Use output from sub-cortical segmentation (FIRST) and easily compare shape and connectivity analyses
<li> The same point above holds for cortical surface, i.e. comparing cortical folding/thickness and connectivity analyses
</ul>


<h4>Examples</h4>

The main difference between the various surface formats is the transformation conventions 
between voxel space and mm space. In order to use surfaces in probtrackx, you must:
<ol>
<li> Specify the convention used for mm->voxel
<li> Specify a reference volume (unless you are using a combination of surfaces and volumes)
<li> Pre-calculate the transformation to diffusion space
<li> Convert the surface file to ASCII (this will change in the future to allow GIFTI)
</ol>
<p>
Note: in the following examples, the commands in <b>bold</b> are non-FSL commands. You need to install the appropriate software in order to be able to run them.
<p> Also, in the examples below we have used a surface as a <i>seed</i> mask, but they can equally be used as targets etc.

<p>
<ul>
<li> <b>Using FreeSurfer</b>
<p>
Assuming that you have ran <code>recon_all</code> on a subject called <i>john</i>, the following produces the transformation from FreeSurfer's "conformed" space to diffusion space:
<pre>
<code>
  <b>tkregister2 --mov $SUBJECTS_DIR/john/mri/orig.mgz --targ $SUBJECTS_DIR/john/mri/rawavg.mgz \
              --regheader --reg junk --fslregout freesurfer2struct.mat --noedit </b>
  convert_xfm -omat struct2freesurfer.mat -inverse freesurfer2struct.mat
  convert_xfm -omat diff2freesurfer.mat -concat struct2freesurfer.mat diff2struct.mat 
  convert_xfm -omat freesurfer2diff.mat -inverse diff2freesurfer.mat
</code></pre>
</p>
<p>
You can produce a reference volume using the following FreeSurfer command:
<pre><code>
  <b>mri_convert $SUBJECTS_DIR/john/mri/orig.mgz refvol.nii.gz</b>
</code></pre>

<p>
Now you can run probtrackx using, e.g., the grey/white interface from FreeSurfer (called <code>lh.white.asc</code>), as a seed:
<pre>
<code>
   probtrackx --seed=lh.white.asc --meshspace=freesurfer --refvol=refvol.nii.gz --xfm=freesurfer2diff.mat [+other options]
</code>
</pre>

<li> <b>Using Caret</b>

<p>Assuming you are using a surface associated with a given volume in Caret, you need to first convert these two to FSL-friendly formats:
<pre><code>
     <b>caret_command -file-convert -format-convert ASCII mysurf.coord mysurf.topo</b>
 OR
     <b>caret_command -file-convert -format-convert ASCII mysurf.gii</b>
 AND
     <b>caret_command -file-convert -vc myvol.HEAD myvol.nii.gz </b>

</pre></code>
<p>These will produce <code>mysurf.asc</code> and <code>myvol.nii.gz</code> 
which you can use in probtrackx as follows:
<pre><code>
   probtrackx --seed=mysurf.asc --meshspace=caret --refvol=myvol.nii.gz --xfm=myvol2diff.mat [+other options]
</pre></code>
<p>In the above example, we assume you have pre-calculated a FLIRT transform between myvol.nii.gz and diffusion space.

<li> <b>Using FIRST</b>
<p>FIRST produces surface files that look like <code>Subject-R_Thal_first.vtk</code> (e.g. for the right thalamus). 
You can use these surfaces directly in probtrackx, in combination with the structural brain that was the input
to FIRST (say it was called <code>struct_brain.nii.gz</code>):
<pre><code>
  probtrackx --seed=Subject-R_Thal_first.vtk --meshspace=first --refvol=struct_brain --xfm=struct2diff.mat
</pre></code>

<li> <b>Combining surfaces from different software tools</b>
<p>You may want to combine surfaces from different software tools, for example a sub-cortical structure from
FIRST with a cortical structure from FreeSurfer. In this case, you need to convert all your surfaces into the 
same "convention". For example, if you choose to work in FIRST convention:
<pre><code>
   surf2surf --surfin=ListOfCaretSurfaces.txt --surfout=ListOfFIRSTSurfaces.txt --convin=caret \
             --convout=first --volin=caretVolume.nii.gz --volout=FirstVolume.nii.gz

   surf2surf --surfin=ListOfFreeSurferSurfaces.txt --surfout=ListOfFIRSTSurfaces.txt --convin=freesurfer \
             --convout=first --volin=orig.nii.gz --volout=FirstVolume.nii.gz

</pre></code>

</ul>

<HR>
<FONT SIZE=1>Copyright &copy; 2000-2011, written by
<A HREF="http://www.fmrib.ox.ac.uk/~saad/index.html">S. Jbabdi</A>.
</FONT>

